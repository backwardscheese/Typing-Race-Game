<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Typing Race</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        input[type="text"] {
            width: 100%;
            padding: 15px;
            font-size: 18px;
            border: 2px solid #ddd;
            border-radius: 10px;
            margin-bottom: 20px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.3s;
            width: 100%;
        }

        button:hover {
            background: #5568d3;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .players-list {
            margin: 20px 0;
        }

        .player-item {
            background: #f7f7f7;
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
        }

        .player-name {
            font-weight: bold;
            color: #333;
        }

        .countdown {
            font-size: 72px;
            text-align: center;
            color: #667eea;
            margin: 50px 0;
            font-weight: bold;
        }

        .error {
            color: #f44336;
            padding: 10px;
            background: #ffebee;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        /* Race Track Styles */
        .race-track-container {
            margin: 30px 0;
            padding: 20px;
            background: #f0f0f0;
            border-radius: 15px;
        }

        .track {
            position: relative;
            margin: 15px 0;
            height: 60px;
            background: white;
            border-radius: 10px;
            border: 2px solid #ddd;
            overflow: hidden;
        }

        .track-bg {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, 
                #e8f5e9 0%, 
                #e8f5e9 100%);
        }

        .finish-line {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: repeating-linear-gradient(
                45deg,
                #000,
                #000 10px,
                #fff 10px,
                #fff 20px
            );
        }

        .racer {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            transition: left 0.3s ease-out;
            font-size: 32px;
            z-index: 10;
        }

        .racer-info {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-weight: bold;
            color: #333;
            background: rgba(255,255,255,0.9);
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 14px;
            z-index: 5;
        }

        .racer-stats {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
            color: #666;
            background: rgba(255,255,255,0.9);
            padding: 5px 8px;
            border-radius: 5px;
        }

        .text-display {
            background: #f7f7f7;
            padding: 25px;
            border-radius: 10px;
            font-size: 22px;
            line-height: 1.8;
            margin: 20px 0;
            min-height: 120px;
        }

        .text-display span.correct {
            color: #4caf50;
            font-weight: bold;
        }

        .text-display span.incorrect {
            color: #f44336;
            background: #ffebee;
        }

        .text-display span.current {
            background: #fff9c4;
            border-bottom: 2px solid #fbc02d;
        }

        .typing-input {
            font-size: 20px;
            font-family: monospace;
        }

        .stats-bar {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin: 20px 0;
            padding: 15px;
            background: #f7f7f7;
            border-radius: 10px;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #666;
            margin-top: 5px;
            font-size: 14px;
        }

        .results-podium {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            gap: 20px;
            margin: 40px 0;
            height: 300px;
        }

        .podium-place {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .podium-racer {
            font-size: 48px;
        }

        .podium-block {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px 10px 0 0;
            text-align: center;
            min-width: 150px;
        }

        .podium-block.first {
            height: 200px;
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            color: #333;
        }

        .podium-block.second {
            height: 150px;
            background: linear-gradient(135deg, #c0c0c0 0%, #e8e8e8 100%);
            color: #333;
        }

        .podium-block.third {
            height: 120px;
            background: linear-gradient(135deg, #cd7f32 0%, #e8a87c 100%);
            color: white;
        }

        .podium-name {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 10px;
        }

        .podium-stats {
            font-size: 14px;
        }

        .waiting-message {
            text-align: center;
            color: #666;
            font-size: 18px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üèÅ Typing Race</h1>

        <!-- Login Screen -->
        <div id="loginScreen" class="screen active">
            <input type="text" id="nameInput" placeholder="Enter your screen name" maxlength="20">
            <button id="joinBtn">Join Race</button>
            <div id="loginError" class="error" style="display:none;"></div>
        </div>

        <!-- Lobby Screen -->
        <div id="lobbyScreen" class="screen">
            <h2 style="text-align: center; margin-bottom: 20px;">üèéÔ∏è Waiting Room</h2>
            <div class="waiting-message">Waiting for more racers to join...</div>
            <div class="players-list" id="lobbyPlayers"></div>
            <button id="startBtn" style="margin-top: 20px;">Start Race</button>
        </div>

        <!-- Race Screen -->
        <div id="raceScreen" class="screen">
            <div id="countdown" class="countdown" style="display:none;"></div>
            
            <div id="raceContent" style="display:none;">
                <div class="race-track-container" id="raceTrack"></div>
                
                <div class="text-display" id="textDisplay"></div>
                <input type="text" class="typing-input" id="typingInput" placeholder="Start typing when the race begins..." disabled>
                
                <div class="stats-bar">
                    <div class="stat">
                        <div class="stat-value" id="wpm">0</div>
                        <div class="stat-label">WPM</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="accuracy">100</div>
                        <div class="stat-label">Accuracy %</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="progress">0</div>
                        <div class="stat-label">Progress %</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Screen -->
        <div id="resultsScreen" class="screen">
            <h2 style="text-align: center; margin-bottom: 30px;">üèÜ Race Results</h2>
            <div class="results-podium" id="podium"></div>
            <div class="players-list" id="resultsPlayers"></div>
            <button id="newRaceBtn" style="margin-top: 20px;">New Race</button>
        </div>
    </div>

    <script type="module">
        // IMPORTANT: Replace with your Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyDUH0fFq0owj4Izfn-9l5VdjI9SpZ6A3Ns",
            authDomain: "mp-typing-race-28105.firebaseapp.com",
            databaseURL: "https://mp-typing-race-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "mp-typing-race-28105",
            storageBucket: "mp-typing-race-28105.firebasestorage.app",
            messagingSenderId: "507061937842",
            appId: "1:507061937842:web:70282da8633ea929828bab"
        };

        // Sample texts - replace with your textbook content
        const textBlocks = [
            "The quick brown fox jumps over the lazy dog. Programming is both an art and a science that requires creativity and logic.",
            "Learning to type quickly improves productivity and communication. Practice makes perfect when developing new skills.",
            "Technology shapes our modern world in countless ways. Innovation drives progress and creates new opportunities for everyone.",
            "Education empowers individuals to reach their full potential. Knowledge opens doors to understanding and growth.",
            "Collaboration brings people together to achieve common goals. Teamwork creates stronger solutions than working alone."
        ];

        // Racer icons - cycling through different emojis
        const racerIcons = ['üèéÔ∏è', 'üöó', 'üöï', 'üöô', 'üöå', 'üöê', 'üèçÔ∏è', 'üõµ', 'üö≤', 'üõ¥'];
        const playerColors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E2'];

        let app, db, raceRef;
        let playerId = null;
        let playerName = null;
        let playerIcon = null;
        let currentText = "";
        let startTime = null;
        let charIndex = 0;
        let errors = 0;
        let totalChars = 0;

        // Initialize Firebase
        async function initFirebase() {
            try {
                console.log('Initializing Firebase...');
                const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
                const { getDatabase, ref, set, push, onValue, update, remove, get } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js');
                
                console.log('Firebase modules loaded');
                app = initializeApp(firebaseConfig);
                console.log('Firebase app initialized');
                db = getDatabase(app);
                console.log('Database reference created');
                raceRef = ref(db, 'race');

                window.dbFunctions = { ref, set, push, onValue, update, remove, get };
                
                setupEventListeners();
                console.log('Setup complete!');
            } catch (error) {
                showError('Firebase initialization failed. Please check your configuration.');
                console.error('Firebase Error:', error);
                alert('Firebase Error: ' + error.message);
            }
        }

        function setupEventListeners() {
            document.getElementById('joinBtn').addEventListener('click', joinRace);
            document.getElementById('startBtn').addEventListener('click', startRace);
            document.getElementById('typingInput').addEventListener('input', handleTyping);
            document.getElementById('newRaceBtn').addEventListener('click', resetRace);
            
            document.getElementById('nameInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') joinRace();
            });
        }

        async function joinRace() {
            console.log('Join race clicked');
            const name = document.getElementById('nameInput').value.trim();
            console.log('Name entered:', name);
            
            if (!name) {
                showError('Please enter a screen name');
                return;
            }

            playerName = name;
            playerId = 'player_' + Date.now();
            playerIcon = racerIcons[Math.floor(Math.random() * racerIcons.length)];
            console.log('Player ID:', playerId);

            const { ref, set, onValue, get } = window.dbFunctions;
            const playerRef = ref(db, `race/players/${playerId}`);
            
            try {
                console.log('Attempting to set player data...');
                await set(playerRef, {
                    name: playerName,
                    icon: playerIcon,
                    progress: 0,
                    wpm: 0,
                    accuracy: 100,
                    finished: false,
                    finishTime: null
                });
                console.log('Player data set successfully!');

                showScreen('lobbyScreen');
                listenToRace();
            } catch (error) {
                showError('Failed to join race. Please try again.');
                console.error('Join race error:', error);
                alert('Join Error: ' + error.message);
            }
        }

        function listenToRace() {
            const { ref, onValue } = window.dbFunctions;
            const raceDataRef = ref(db, 'race');

            onValue(raceDataRef, (snapshot) => {
                const data = snapshot.val();
                if (!data) return;

                const players = data.players || {};
                const status = data.status || 'lobby';
                const text = data.text || '';

                if (status === 'lobby') {
                    updateLobby(players);
                } else if (status === 'countdown') {
                    showScreen('raceScreen');
                    startCountdown();
                } else if (status === 'racing') {
                    showScreen('raceScreen');
                    document.getElementById('countdown').style.display = 'none';
                    document.getElementById('raceContent').style.display = 'block';
                    
                    if (!currentText) {
                        currentText = text;
                        displayText();
                        document.getElementById('typingInput').disabled = false;
                        document.getElementById('typingInput').focus();
                        startTime = Date.now();
                    }
                    updateRaceTrack(players);
                } else if (status === 'finished') {
                    showScreen('resultsScreen');
                    updateResults(players);
                }
            });
        }

        function updateLobby(players) {
            const container = document.getElementById('lobbyPlayers');
            container.innerHTML = '';
            
            Object.entries(players).forEach(([id, player]) => {
                const div = document.createElement('div');
                div.className = 'player-item';
                div.innerHTML = `
                    <span style="font-size: 24px; margin-right: 10px;">${player.icon}</span>
                    <span class="player-name">${player.name}</span>
                `;
                container.appendChild(div);
            });
        }

        async function startRace() {
            const { ref, set } = window.dbFunctions;
            const selectedText = textBlocks[Math.floor(Math.random() * textBlocks.length)];
            
            await set(ref(db, 'race/status'), 'countdown');
            await set(ref(db, 'race/text'), selectedText);
        }

        async function startCountdown() {
            const countdownEl = document.getElementById('countdown');
            const typingInput = document.getElementById('typingInput');
            
            countdownEl.style.display = 'block';
            document.getElementById('raceContent').style.display = 'none';
            typingInput.disabled = true;

            for (let i = 3; i > 0; i--) {
                countdownEl.textContent = i;
                await new Promise(resolve => setTimeout(resolve, 1000));
            }

            countdownEl.textContent = 'GO!';
            await new Promise(resolve => setTimeout(resolve, 500));

            const { ref, set } = window.dbFunctions;
            await set(ref(db, 'race/status'), 'racing');
        }

        function displayText() {
            const display = document.getElementById('textDisplay');
            display.innerHTML = currentText.split('').map((char, i) => {
                return `<span id="char-${i}">${char}</span>`;
            }).join('');
        }

        function updateRaceTrack(players) {
            const container = document.getElementById('raceTrack');
            const sortedPlayers = Object.entries(players).sort((a, b) => b[1].progress - a[1].progress);
            
            container.innerHTML = '';
            
            sortedPlayers.forEach(([id, player], index) => {
                const track = document.createElement('div');
                track.className = 'track';
                
                const trackBg = document.createElement('div');
                trackBg.className = 'track-bg';
                
                const finishLine = document.createElement('div');
                finishLine.className = 'finish-line';
                
                const racerInfo = document.createElement('div');
                racerInfo.className = 'racer-info';
                racerInfo.textContent = player.name;
                if (id === playerId) {
                    racerInfo.style.fontWeight = 'bold';
                    racerInfo.style.background = '#fff9c4';
                }
                
                const racer = document.createElement('div');
                racer.className = 'racer';
                racer.textContent = player.icon;
                racer.style.left = `${Math.min(player.progress, 100)}%`;
                if (player.finished) {
                    racer.style.left = 'calc(100% - 40px)';
                }
                
                const racerStats = document.createElement('div');
                racerStats.className = 'racer-stats';
                racerStats.textContent = `${player.wpm} WPM | ${Math.round(player.progress)}%`;
                
                track.appendChild(trackBg);
                track.appendChild(finishLine);
                track.appendChild(racerInfo);
                track.appendChild(racer);
                track.appendChild(racerStats);
                
                container.appendChild(track);
            });
        }

        async function handleTyping(e) {
            const input = e.target.value;
            const currentChar = currentText[charIndex];

            if (input.endsWith(currentChar)) {
                document.getElementById(`char-${charIndex}`).className = 'correct';
                charIndex++;
                totalChars++;
            } else if (input.length > 0) {
                document.getElementById(`char-${charIndex}`).className = 'incorrect';
                errors++;
                totalChars++;
            }

            if (charIndex < currentText.length) {
                document.getElementById(`char-${charIndex}`).className = 'current';
            }

            e.target.value = '';

            const progress = (charIndex / currentText.length) * 100;
            const timeElapsed = (Date.now() - startTime) / 1000 / 60;
            const wpm = Math.round((charIndex / 5) / timeElapsed) || 0;
            const accuracy = totalChars > 0 ? Math.round(((totalChars - errors) / totalChars) * 100) : 100;

            document.getElementById('wpm').textContent = wpm;
            document.getElementById('accuracy').textContent = accuracy;
            document.getElementById('progress').textContent = Math.round(progress);

            const { ref, update } = window.dbFunctions;
            await update(ref(db, `race/players/${playerId}`), {
                progress,
                wpm,
                accuracy
            });

            if (charIndex >= currentText.length) {
                await finishRace(wpm, accuracy, progress);
            }
        }

        async function finishRace(wpm, accuracy, progress) {
            document.getElementById('typingInput').disabled = true;
            
            const { ref, update, get } = window.dbFunctions;
            await update(ref(db, `race/players/${playerId}`), {
                finished: true,
                finishTime: Date.now(),
                wpm,
                accuracy,
                progress: 100
            });

            const playersSnapshot = await get(ref(db, 'race/players'));
            const players = playersSnapshot.val();
            const allFinished = Object.values(players).every(p => p.finished);

            if (allFinished) {
                await update(ref(db, 'race'), { status: 'finished' });
            }
        }

        function updateResults(players) {
            const podium = document.getElementById('podium');
            const container = document.getElementById('resultsPlayers');
            
            podium.innerHTML = '';
            container.innerHTML = '';
            
            const sorted = Object.entries(players)
                .filter(([_, p]) => p.finished)
                .sort((a, b) => a[1].finishTime - b[1].finishTime);
            
            // Create podium for top 3
            const podiumOrder = [1, 0, 2]; // Display order: 2nd, 1st, 3rd
            const podiumClasses = ['second', 'first', 'third'];
            const medals = ['ü•à', 'ü•á', 'ü•â'];
            
            podiumOrder.forEach((index, displayIndex) => {
                if (sorted[index]) {
                    const [id, player] = sorted[index];
                    const place = document.createElement('div');
                    place.className = 'podium-place';
                    
                    place.innerHTML = `
                        <div class="podium-racer">${player.icon}</div>
                        <div class="podium-block ${podiumClasses[displayIndex]}">
                            <div style="font-size: 32px; margin-bottom: 10px;">${medals[displayIndex]}</div>
                            <div class="podium-name">${player.name}</div>
                            <div class="podium-stats">${player.wpm} WPM</div>
                            <div class="podium-stats">${player.accuracy}% accuracy</div>
                        </div>
                    `;
                    
                    podium.appendChild(place);
                }
            });
            
            // List all results
            sorted.forEach(([id, player], index) => {
                const div = document.createElement('div');
                div.className = 'player-item';
                div.innerHTML = `
                    <div>
                        <span style="font-size: 24px; margin-right: 10px;">${index < 3 ? ['ü•á', 'ü•à', 'ü•â'][index] : `#${index + 1}`}</span>
                        <span style="font-size: 24px; margin-right: 10px;">${player.icon}</span>
                        <span class="player-name">${player.name}</span>
                    </div>
                    <div>
                        <strong>${player.wpm} WPM</strong> | ${player.accuracy}% accuracy
                    </div>
                `;
                container.appendChild(div);
            });
        }

        async function resetRace() {
            const { ref, set } = window.dbFunctions;
            await set(ref(db, 'race'), {
                status: 'lobby',
                text: '',
                players: {}
            });
            
            charIndex = 0;
            errors = 0;
            totalChars = 0;
            currentText = '';
            startTime = null;
            
            showScreen('loginScreen');
            document.getElementById('nameInput').value = '';
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function showError(msg) {
            const errorEl = document.getElementById('loginError');
            errorEl.textContent = msg;
            errorEl.style.display = 'block';
            setTimeout(() => errorEl.style.display = 'none', 3000);
        }

        initFirebase();
    </script>
</body>
</html>
