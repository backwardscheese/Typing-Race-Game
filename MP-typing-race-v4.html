<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Typing Race</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        input[type="text"] {
            width: 100%;
            padding: 15px;
            font-size: 18px;
            border: 2px solid #ddd;
            border-radius: 10px;
            margin-bottom: 20px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.3s;
            width: 100%;
        }

        button:hover {
            background: #5568d3;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .players-list {
            margin: 20px 0;
        }

        .player-item {
            background: #f7f7f7;
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
        }

        .player-name {
            font-weight: bold;
            color: #333;
        }

        .countdown {
            font-size: 72px;
            text-align: center;
            color: #667eea;
            margin: 50px 0;
            font-weight: bold;
        }

        .error {
            color: #f44336;
            padding: 10px;
            background: #ffebee;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        /* Race Track Styles */
        .race-track-container {
            margin: 30px 0;
            padding: 20px;
            background: #f0f0f0;
            border-radius: 15px;
        }

        .track {
            position: relative;
            margin: 15px 0;
            height: 60px;
            background: white;
            border-radius: 10px;
            border: 2px solid #ddd;
            overflow: hidden;
        }

        .track-bg {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, 
                #e8f5e9 0%, 
                #e8f5e9 100%);
        }

        .finish-line {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: repeating-linear-gradient(
                45deg,
                #000,
                #000 10px,
                #fff 10px,
                #fff 20px
            );
        }

        .racer {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            transition: left 0.3s ease-out;
            font-size: 32px;
            z-index: 10;
        }

        .racer-info {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-weight: bold;
            color: #333;
            background: rgba(255,255,255,0.9);
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 14px;
            z-index: 5;
        }

        .racer-stats {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
            color: #666;
            background: rgba(255,255,255,0.9);
            padding: 5px 8px;
            border-radius: 5px;
        }

        .text-display {
            background: #f7f7f7;
            padding: 25px;
            border-radius: 10px;
            font-size: 22px;
            line-height: 1.8;
            margin: 20px 0;
            min-height: 120px;
        }

        .text-display span.correct {
            color: #4caf50;
            font-weight: bold;
        }

        .text-display span.incorrect {
            color: #f44336;
            background: #ffebee;
        }

        .text-display span.current {
            background: #fff9c4;
            border-bottom: 2px solid #fbc02d;
        }

        .typing-input {
            font-size: 20px;
            font-family: monospace;
        }

        .stats-bar {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin: 20px 0;
            padding: 15px;
            background: #f7f7f7;
            border-radius: 10px;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #666;
            margin-top: 5px;
            font-size: 14px;
        }

        .results-podium {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            gap: 20px;
            margin: 40px 0;
            height: 300px;
        }

        .podium-place {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .podium-racer {
            font-size: 48px;
        }

        .podium-block {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px 10px 0 0;
            text-align: center;
            min-width: 150px;
        }

        .podium-block.first {
            height: 200px;
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            color: #333;
        }

        .podium-block.second {
            height: 150px;
            background: linear-gradient(135deg, #c0c0c0 0%, #e8e8e8 100%);
            color: #333;
        }

        .podium-block.third {
            height: 120px;
            background: linear-gradient(135deg, #cd7f32 0%, #e8a87c 100%);
            color: white;
        }

        .podium-name {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 10px;
        }

        .podium-stats {
            font-size: 14px;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin: 8px 0;
            background: #f7f7f7;
            border-radius: 10px;
        }

        .leaderboard-rank {
            font-size: 20px;
            font-weight: bold;
            color: #667eea;
            min-width: 40px;
        }

        .leaderboard-info {
            flex: 1;
            margin-left: 15px;
        }

        .leaderboard-name {
            font-weight: bold;
            font-size: 16px;
        }

        .leaderboard-date {
            color: #999;
            font-size: 12px;
            margin-top: 3px;
        }

        .leaderboard-stats {
            text-align: right;
            font-weight: bold;
            color: #667eea;
        }

        .waiting-message {
            text-align: center;
            color: #666;
            font-size: 18px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üèÅ Typing Race üèÅ</h1>

        <!-- Login Screen -->
        <div id="loginScreen" class="screen active">
            <div style="text-align: center; margin-bottom: 20px;">
                <button id="teacherModeBtn" style="background: #764ba2; width: auto; display: inline-block; margin-bottom: 20px;">
                    üë®‚Äçüè´ Teacher Login
                </button>
            </div>
            <input type="text" id="nameInput" placeholder="Enter your screen name" maxlength="20">
            <button id="joinBtn">Join Race</button>
            <div id="loginError" class="error" style="display:none;"></div>
        </div>

        <!-- Teacher Login -->
        <div id="teacherLoginScreen" class="screen">
            <h2 style="text-align: center; margin-bottom: 20px;">üë®‚Äçüè´ Teacher Login</h2>
            <input type="password" id="teacherPassword" placeholder="Enter teacher password">
            <button id="teacherLoginBtn">Login</button>
            <button id="backToStudentBtn" style="background: #999; margin-top: 10px;">Back</button>
            <div id="teacherLoginError" class="error" style="display:none;"></div>
        </div>

        <!-- Teacher Control Panel -->
        <div id="teacherPanel" class="screen">
            <h2 style="text-align: center; margin-bottom: 20px;">üë®‚Äçüè´ Teacher Control Panel</h2>
            
            <div class="stats-bar" style="margin-bottom: 30px;">
                <div class="stat">
                    <div class="stat-value" id="teacherPlayerCount">0</div>
                    <div class="stat-label">Players in Lobby</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="teacherStatus">Waiting</div>
                    <div class="stat-label">Race Status</div>
                </div>
            </div>

            <div class="players-list" id="teacherPlayers"></div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px;">
                <button id="teacherStartBtn">üèÅ Start Race</button>
                <button id="teacherEndBtn" style="background: #f44336;">‚èπÔ∏è End Race</button>
                <button id="teacherResetBtn" style="background: #ff9800;">üîÑ Reset All</button>
                <button id="teacherLogoutBtn" style="background: #999;">üö™ Logout</button>
            </div>

            <div style="margin-top: 30px;">
                <h3 style="margin-bottom: 15px;">Select Text for Next Race:</h3>
                <select id="textSelector" style="width: 100%; padding: 10px; font-size: 16px; border-radius: 5px; border: 2px solid #ddd;">
                    <option value="random">Random Text</option>
                </select>
            </div>
        </div>

        <!-- Lobby Screen -->
        <div id="lobbyScreen" class="screen">
            <h2 style="text-align: center; margin-bottom: 20px;">üèéÔ∏è Waiting Room</h2>
            <div class="waiting-message">Waiting for teacher to start the race...</div>
            <div class="players-list" id="lobbyPlayers"></div>
        </div>

        <!-- Race Screen -->
        <div id="raceScreen" class="screen">
            <div id="countdown" class="countdown" style="display:none;"></div>
            
            <div id="raceContent" style="display:none;">
                <div class="race-track-container" id="raceTrack"></div>
                
                <div class="text-display" id="textDisplay"></div>
                <input type="text" class="typing-input" id="typingInput" placeholder="Start typing when the race begins..." disabled>
                
                <div class="stats-bar">
                    <div class="stat">
                        <div class="stat-value" id="wpm">0</div>
                        <div class="stat-label">WPM</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="accuracy">100</div>
                        <div class="stat-label">Accuracy %</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="progress">0</div>
                        <div class="stat-label">Progress %</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Finished Screen (individual) -->
        <div id="finishedScreen" class="screen">
            <div style="text-align: center; margin: 50px 0;">
                <div style="font-size: 80px; margin-bottom: 20px;">üèÅ</div>
                <h2 style="color: #4caf50; margin-bottom: 20px;">You Finished!</h2>
                <div class="stats-bar" style="max-width: 500px; margin: 30px auto;">
                    <div class="stat">
                        <div class="stat-value" id="finalWpm">0</div>
                        <div class="stat-label">WPM</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="finalAccuracy">100</div>
                        <div class="stat-label">Accuracy %</div>
                    </div>
                </div>
                <div class="waiting-message">Waiting for other racers to finish...</div>
                <div class="race-track-container" id="finishedTrack" style="margin-top: 30px;"></div>
            </div>
        </div>

        <!-- Results Screen -->
        <div id="resultsScreen" class="screen">
            <h2 style="text-align: center; margin-bottom: 30px;">üèÜ Race Results</h2>
            <div class="results-podium" id="podium"></div>
            <div class="players-list" id="resultsPlayers"></div>
            
            <h3 style="text-align: center; margin: 40px 0 20px 0;">üìä All-Time Leaderboard</h3>
            <div class="players-list" id="leaderboard"></div>
            
            <button id="newRaceBtn" style="margin-top: 20px;">New Race</button>
        </div>
    </div>

    <script type="module">
        // IMPORTANT: Replace with your Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyDUH0fFq0owj4Izfn-9l5VdjI9SpZ6A3Ns",
            authDomain: "mp-typing-race-28105.firebaseapp.com",
            databaseURL: "https://mp-typing-race-28105-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "mp-typing-race-28105",
            storageBucket: "mp-typing-race-28105.firebasestorage.app",
            messagingSenderId: "507061937842",
            appId: "1:507061937842:web:70282da8633ea929828bab"
        };

        // TEACHER PASSWORD - Change this to whatever you want
        const TEACHER_PASSWORD = "teacher123";

        // Sample texts - replace with your textbook content
        const textBlocks = [
            "I'm from Iwate. I live in the U.S. I am a baseball player.",
            "I'm interested in dancing. I'm good at cooking. I can make sushi.",
            "What season do you like? I like spring. In spring, we have hanami.",
            "Welcome to Japan. In Japan you can eat sukiyaki. It's delicious. You can visit Tokyo SkyTree. It's tall.",
            "Do you wash the dishes? No, I don't. I never wash the dishes. I sometimes clean my room and I always wash the bath.",
			"I usually go to school at 8:00. I usually have 6 classes. I sometimes play baseball after school. I sometimes cook dinner.",
			"What did you do in summer? I enjoyed camping. How was it? It was great.",
			"My summer vacation. I went to Akita. I enjoyed a summer festival. I ate watermelon. It was delicious.",
			"I live in the forest. I eat leaves. We don't have many trees. I want more trees.",
			"I live on the ice. I am big and white. I eat fish. I want a lot of ice.",
			"I want to visit New York. Why? I want to see the Statue of liberty. It's a famous statue in America. Wow. Amazing.",
			"I like baseball very much. I want to join the baseball team. I like school lunch very much, too. I want to be a teacher."
        ];

        // Racer icons - cycling through different emojis
        const racerIcons = ['üèéÔ∏è', 'üöó', 'üöï', 'üöô', 'üöå', 'üöê', 'üèçÔ∏è', 'üõµ', 'üö≤', 'üõ¥'];
        const playerColors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E2'];

        let app, db, raceRef;
        let playerId = null;
        let playerName = null;
        let playerIcon = null;
        let currentText = "";
        let startTime = null;
        let charIndex = 0;
        let errors = 0;
        let totalChars = 0;
        let isTeacher = false;
        let selectedTextIndex = -1; // -1 means random

        // Initialize Firebase
        async function initFirebase() {
            try {
                console.log('Initializing Firebase...');
                const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
                const { getDatabase, ref, set, push, onValue, update, remove, get } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js');
                
                console.log('Firebase modules loaded');
                app = initializeApp(firebaseConfig);
                console.log('Firebase app initialized');
                db = getDatabase(app);
                console.log('Database reference created');
                raceRef = ref(db, 'race');

                window.dbFunctions = { ref, set, push, onValue, update, remove, get };
                
                setupEventListeners();
                console.log('Setup complete!');
            } catch (error) {
                showError('Firebase initialization failed. Please check your configuration.');
                console.error('Firebase Error:', error);
                alert('Firebase Error: ' + error.message);
            }
        }

        function setupEventListeners() {
            document.getElementById('joinBtn').addEventListener('click', joinRace);
            document.getElementById('typingInput').addEventListener('input', handleTyping);
            document.getElementById('newRaceBtn').addEventListener('click', rejoinRace);
            
            document.getElementById('teacherModeBtn').addEventListener('click', () => showScreen('teacherLoginScreen'));
            document.getElementById('teacherLoginBtn').addEventListener('click', teacherLogin);
            document.getElementById('backToStudentBtn').addEventListener('click', () => showScreen('loginScreen'));
            
            document.getElementById('teacherStartBtn').addEventListener('click', teacherStartRace);
            document.getElementById('teacherEndBtn').addEventListener('click', teacherEndRace);
            document.getElementById('teacherResetBtn').addEventListener('click', teacherResetAll);
            document.getElementById('teacherLogoutBtn').addEventListener('click', teacherLogout);
            
            document.getElementById('nameInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') joinRace();
            });

            document.getElementById('teacherPassword').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') teacherLogin();
            });

            // Populate text selector
            const selector = document.getElementById('textSelector');
            textBlocks.forEach((text, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `Text ${index + 1}: ${text.substring(0, 50)}...`;
                selector.appendChild(option);
            });
            selector.addEventListener('change', (e) => {
                selectedTextIndex = e.target.value === 'random' ? -1 : parseInt(e.target.value);
            });
        }

        async function joinRace() {
            console.log('Join race clicked');
            const name = document.getElementById('nameInput').value.trim();
            console.log('Name entered:', name);
            
            if (!name) {
                showError('Please enter a screen name');
                return;
            }

            playerName = name;
            playerId = 'player_' + Date.now();
            playerIcon = racerIcons[Math.floor(Math.random() * racerIcons.length)];
            console.log('Player ID:', playerId);

            const { ref, set, onValue, get } = window.dbFunctions;
            const playerRef = ref(db, `race/players/${playerId}`);
            
            try {
                console.log('Attempting to set player data...');
                await set(playerRef, {
                    name: playerName,
                    icon: playerIcon,
                    progress: 0,
                    wpm: 0,
                    accuracy: 100,
                    finished: false,
                    finishTime: null
                });
                console.log('Player data set successfully!');

                showScreen('lobbyScreen');
                listenToRace();
            } catch (error) {
                showError('Failed to join race. Please try again.');
                console.error('Join race error:', error);
                alert('Join Error: ' + error.message);
            }
        }

        function listenToRace() {
            const { ref, onValue } = window.dbFunctions;
            const raceDataRef = ref(db, 'race');

            onValue(raceDataRef, (snapshot) => {
                const data = snapshot.val();
                if (!data) return;

                const players = data.players || {};
                const status = data.status || 'lobby';
                const text = data.text || '';

                // Update teacher panel if teacher is logged in
                if (isTeacher) {
                    updateTeacherPanel(players, status);
                }

                if (status === 'lobby') {
                    if (!isTeacher) {
                        updateLobby(players);
                    }
                } else if (status === 'countdown') {
                    if (!isTeacher) {
                        showScreen('raceScreen');
                        startCountdown();
                    }
                } else if (status === 'racing') {
                    if (!isTeacher) {
                        showScreen('raceScreen');
                        document.getElementById('countdown').style.display = 'none';
                        document.getElementById('raceContent').style.display = 'block';
                        
                        if (!currentText) {
                            currentText = text;
                            displayText();
                            document.getElementById('typingInput').disabled = false;
                            document.getElementById('typingInput').focus();
                            startTime = Date.now();
                        }
                        
                        // Check if current player has finished
                        if (players[playerId] && players[playerId].finished) {
                            showScreen('finishedScreen');
                            updateFinishedScreen(players);
                        } else {
                            updateRaceTrack(players);
                        }
                    }
                } else if (status === 'finished') {
                    if (!isTeacher) {
                        showScreen('resultsScreen');
                        updateResults(players);
                        loadLeaderboard();
                    }
                }
            });
        }

        function updateLobby(players) {
            const container = document.getElementById('lobbyPlayers');
            container.innerHTML = '';
            
            Object.entries(players).forEach(([id, player]) => {
                const div = document.createElement('div');
                div.className = 'player-item';
                div.innerHTML = `
                    <span style="font-size: 24px; margin-right: 10px;">${player.icon}</span>
                    <span class="player-name">${player.name}</span>
                `;
                container.appendChild(div);
            });
        }

        async function startRace() {
            const { ref, set } = window.dbFunctions;
            const selectedText = selectedTextIndex === -1 
                ? textBlocks[Math.floor(Math.random() * textBlocks.length)]
                : textBlocks[selectedTextIndex];
            
            await set(ref(db, 'race/status'), 'countdown');
            await set(ref(db, 'race/text'), selectedText);
        }

        // Teacher Functions
        function teacherLogin() {
            const password = document.getElementById('teacherPassword').value;
            if (password === TEACHER_PASSWORD) {
                isTeacher = true;
                showScreen('teacherPanel');
                listenToRace();
                document.getElementById('teacherPassword').value = '';
            } else {
                const errorEl = document.getElementById('teacherLoginError');
                errorEl.textContent = 'Incorrect password';
                errorEl.style.display = 'block';
                setTimeout(() => errorEl.style.display = 'none', 3000);
            }
        }

        function teacherLogout() {
            isTeacher = false;
            showScreen('loginScreen');
        }

        async function teacherStartRace() {
            await startRace();
        }

        async function teacherEndRace() {
            const { ref, update } = window.dbFunctions;
            await update(ref(db, 'race'), { status: 'finished' });
        }

        async function teacherResetAll() {
            if (confirm('This will reset the race and remove all players. Continue?')) {
                const { ref, set } = window.dbFunctions;
                await set(ref(db, 'race'), {
                    status: 'lobby',
                    text: '',
                    players: {}
                });
            }
        }

        function updateTeacherPanel(players, status) {
            const playerCount = Object.keys(players).length;
            document.getElementById('teacherPlayerCount').textContent = playerCount;
            
            const statusText = {
                'lobby': 'Waiting',
                'countdown': 'Starting...',
                'racing': 'Racing!',
                'finished': 'Finished'
            };
            document.getElementById('teacherStatus').textContent = statusText[status] || status;

            const container = document.getElementById('teacherPlayers');
            container.innerHTML = '';
            
            Object.entries(players).forEach(([id, player]) => {
                const div = document.createElement('div');
                div.className = 'player-item';
                
                let statusIndicator = '';
                if (status === 'racing') {
                    if (player.finished) {
                        statusIndicator = `<span style="color: #4caf50;">‚úì Finished - ${player.wpm} WPM</span>`;
                    } else {
                        statusIndicator = `<span style="color: #ff9800;">${Math.round(player.progress)}% complete</span>`;
                    }
                }
                
                div.innerHTML = `
                    <div>
                        <span style="font-size: 24px; margin-right: 10px;">${player.icon}</span>
                        <span class="player-name">${player.name}</span>
                    </div>
                    <div>${statusIndicator}</div>
                `;
                container.appendChild(div);
            });

            // Enable/disable buttons based on status
            document.getElementById('teacherStartBtn').disabled = (status !== 'lobby' && status !== 'finished');
            document.getElementById('teacherEndBtn').disabled = (status !== 'racing');
        }

        // Modified rejoin function
        async function rejoinRace() {
            if (!playerName || !playerId) {
                // If somehow they don't have a name, go back to login
                resetRace();
                return;
            }

            const { ref, set } = window.dbFunctions;
            const playerRef = ref(db, `race/players/${playerId}`);
            
            try {
                // Reset player data for new race
                await set(playerRef, {
                    name: playerName,
                    icon: playerIcon,
                    progress: 0,
                    wpm: 0,
                    accuracy: 100,
                    finished: false,
                    finishTime: null
                });

                // Reset local state
                charIndex = 0;
                errors = 0;
                totalChars = 0;
                currentText = '';
                startTime = null;

                showScreen('lobbyScreen');
            } catch (error) {
                console.error('Error rejoining:', error);
                resetRace();
            }
        }

        async function startCountdown() {
            const countdownEl = document.getElementById('countdown');
            const typingInput = document.getElementById('typingInput');
            
            countdownEl.style.display = 'block';
            document.getElementById('raceContent').style.display = 'none';
            typingInput.disabled = true;

            for (let i = 3; i > 0; i--) {
                countdownEl.textContent = i;
                await new Promise(resolve => setTimeout(resolve, 1000));
            }

            countdownEl.textContent = 'GO!';
            await new Promise(resolve => setTimeout(resolve, 500));

            const { ref, set } = window.dbFunctions;
            await set(ref(db, 'race/status'), 'racing');
        }

        function displayText() {
            const display = document.getElementById('textDisplay');
            display.innerHTML = currentText.split('').map((char, i) => {
                return `<span id="char-${i}">${char}</span>`;
            }).join('');
        }

        function updateRaceTrack(players, containerId = 'raceTrack') {
            const container = document.getElementById(containerId);
            const sortedPlayers = Object.entries(players).sort((a, b) => b[1].progress - a[1].progress);
            
            container.innerHTML = '';
            
            sortedPlayers.forEach(([id, player], index) => {
                const track = document.createElement('div');
                track.className = 'track';
                
                const trackBg = document.createElement('div');
                trackBg.className = 'track-bg';
                
                const finishLine = document.createElement('div');
                finishLine.className = 'finish-line';
                
                const racerInfo = document.createElement('div');
                racerInfo.className = 'racer-info';
                racerInfo.textContent = player.name;
                if (id === playerId) {
                    racerInfo.style.fontWeight = 'bold';
                    racerInfo.style.background = '#fff9c4';
                }
                
                const racer = document.createElement('div');
                racer.className = 'racer';
                racer.textContent = player.icon;
                racer.style.left = `${Math.min(player.progress, 100)}%`;
                if (player.finished) {
                    racer.style.left = 'calc(100% - 40px)';
                }
                
                const racerStats = document.createElement('div');
                racerStats.className = 'racer-stats';
                racerStats.textContent = `${player.wpm} WPM | ${Math.round(player.progress)}%`;
                
                track.appendChild(trackBg);
                track.appendChild(finishLine);
                track.appendChild(racerInfo);
                track.appendChild(racer);
                track.appendChild(racerStats);
                
                container.appendChild(track);
            });
        }

        async function handleTyping(e) {
            const input = e.target.value;
            const currentChar = currentText[charIndex];

            if (input.endsWith(currentChar)) {
                document.getElementById(`char-${charIndex}`).className = 'correct';
                charIndex++;
                totalChars++;
            } else if (input.length > 0) {
                document.getElementById(`char-${charIndex}`).className = 'incorrect';
                errors++;
                totalChars++;
            }

            if (charIndex < currentText.length) {
                document.getElementById(`char-${charIndex}`).className = 'current';
            }

            e.target.value = '';

            const progress = (charIndex / currentText.length) * 100;
            const timeElapsed = (Date.now() - startTime) / 1000 / 60;
            const wpm = Math.round((charIndex / 5) / timeElapsed) || 0;
            const accuracy = totalChars > 0 ? Math.round(((totalChars - errors) / totalChars) * 100) : 100;

            document.getElementById('wpm').textContent = wpm;
            document.getElementById('accuracy').textContent = accuracy;
            document.getElementById('progress').textContent = Math.round(progress);

            const { ref, update } = window.dbFunctions;
            await update(ref(db, `race/players/${playerId}`), {
                progress,
                wpm,
                accuracy
            });

            if (charIndex >= currentText.length) {
                await finishRace(wpm, accuracy, progress);
            }
        }

        async function finishRace(wpm, accuracy, progress) {
            document.getElementById('typingInput').disabled = true;
            
            const { ref, update, get, push, set } = window.dbFunctions;
            
            // Update player status
            await update(ref(db, `race/players/${playerId}`), {
                finished: true,
                finishTime: Date.now(),
                wpm,
                accuracy,
                progress: 100
            });

            // Save to leaderboard
            const leaderboardRef = ref(db, 'leaderboard');
            const newEntryRef = push(leaderboardRef);
            await set(newEntryRef, {
                name: playerName,
                icon: playerIcon,
                wpm,
                accuracy,
                timestamp: Date.now(),
                date: new Date().toLocaleDateString()
            });

            // Show finished screen
            document.getElementById('finalWpm').textContent = wpm;
            document.getElementById('finalAccuracy').textContent = accuracy;
            showScreen('finishedScreen');

            // Check if all finished
            const playersSnapshot = await get(ref(db, 'race/players'));
            const players = playersSnapshot.val();
            const allFinished = Object.values(players).every(p => p.finished);

            if (allFinished) {
                await update(ref(db, 'race'), { status: 'finished' });
            }
        }

        function updateFinishedScreen(players) {
            updateRaceTrack(players, 'finishedTrack');
        }

        function updateResults(players) {
            const podium = document.getElementById('podium');
            const container = document.getElementById('resultsPlayers');
            
            podium.innerHTML = '';
            container.innerHTML = '';
            
            const sorted = Object.entries(players)
                .filter(([_, p]) => p.finished)
                .sort((a, b) => a[1].finishTime - b[1].finishTime);
            
            // Create podium for top 3
            const podiumOrder = [1, 0, 2]; // Display order: 2nd, 1st, 3rd
            const podiumClasses = ['second', 'first', 'third'];
            const medals = ['ü•à', 'ü•á', 'ü•â'];
            
            podiumOrder.forEach((index, displayIndex) => {
                if (sorted[index]) {
                    const [id, player] = sorted[index];
                    const place = document.createElement('div');
                    place.className = 'podium-place';
                    
                    place.innerHTML = `
                        <div class="podium-racer">${player.icon}</div>
                        <div class="podium-block ${podiumClasses[displayIndex]}">
                            <div style="font-size: 32px; margin-bottom: 10px;">${medals[displayIndex]}</div>
                            <div class="podium-name">${player.name}</div>
                            <div class="podium-stats">${player.wpm} WPM</div>
                            <div class="podium-stats">${player.accuracy}% accuracy</div>
                        </div>
                    `;
                    
                    podium.appendChild(place);
                }
            });
            
            // List all results
            sorted.forEach(([id, player], index) => {
                const div = document.createElement('div');
                div.className = 'player-item';
                div.innerHTML = `
                    <div>
                        <span style="font-size: 24px; margin-right: 10px;">${index < 3 ? ['ü•á', 'ü•à', 'ü•â'][index] : `#${index + 1}`}</span>
                        <span style="font-size: 24px; margin-right: 10px;">${player.icon}</span>
                        <span class="player-name">${player.name}</span>
                    </div>
                    <div>
                        <strong>${player.wpm} WPM</strong> | ${player.accuracy}% accuracy
                    </div>
                `;
                container.appendChild(div);
            });
        }

        async function loadLeaderboard() {
            const { ref, get } = window.dbFunctions;
            const leaderboardRef = ref(db, 'leaderboard');
            
            try {
                const snapshot = await get(leaderboardRef);
                const data = snapshot.val();
                
                if (!data) {
                    document.getElementById('leaderboard').innerHTML = '<div class="waiting-message">No records yet!</div>';
                    return;
                }
                
                // Convert to array and sort by WPM
                const entries = Object.entries(data)
                    .map(([id, entry]) => entry)
                    .sort((a, b) => b.wpm - a.wpm)
                    .slice(0, 10); // Top 10
                
                const container = document.getElementById('leaderboard');
                container.innerHTML = '';
                
                entries.forEach((entry, index) => {
                    const div = document.createElement('div');
                    div.className = 'leaderboard-item';
                    
                    const rankDisplay = index < 3 ? ['ü•á', 'ü•à', 'ü•â'][index] : `#${index + 1}`;
                    
                    div.innerHTML = `
                        <div class="leaderboard-rank">${rankDisplay}</div>
                        <div style="font-size: 24px; margin-right: 10px;">${entry.icon}</div>
                        <div class="leaderboard-info">
                            <div class="leaderboard-name">${entry.name}</div>
                            <div class="leaderboard-date">${entry.date}</div>
                        </div>
                        <div class="leaderboard-stats">
                            <div>${entry.wpm} WPM</div>
                            <div style="font-size: 12px; color: #999;">${entry.accuracy}% acc</div>
                        </div>
                    `;
                    
                    container.appendChild(div);
                });
            } catch (error) {
                console.error('Error loading leaderboard:', error);
            }
        }

        async function resetRace() {
            const { ref, set } = window.dbFunctions;
            await set(ref(db, 'race'), {
                status: 'lobby',
                text: '',
                players: {}
            });
            
            charIndex = 0;
            errors = 0;
            totalChars = 0;
            currentText = '';
            startTime = null;
            
            showScreen('loginScreen');
            document.getElementById('nameInput').value = '';
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function showError(msg) {
            const errorEl = document.getElementById('loginError');
            errorEl.textContent = msg;
            errorEl.style.display = 'block';
            setTimeout(() => errorEl.style.display = 'none', 3000);
        }

        initFirebase();
    </script>
</body>
</html>
